#!/bin/sh
# Simple Redis log formatter using only shell built-ins and sed
# Converts Redis timestamp format to match application logs
# Example: "1:M 16 Oct 2025 16:31:02.086 * Ready"
# Becomes: "2025-10-16 16:31:02 | INFO     | redis                | Ready"

exec redis-server "$@" 2>&1 | sed -u '
# Match and reformat Redis log lines
s/^[0-9]*:[MSCX] \([0-9]*\) Jan \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-01-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Feb \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-02-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Mar \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-03-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Apr \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-04-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) May \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-05-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Jun \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-06-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Jul \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-07-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Aug \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-08-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Sep \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-09-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Oct \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-10-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Nov \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-11-\1 \3 | INFO     | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Dec \([0-9]*\) \([0-9:]*\)\.[0-9]* \* \(.*\)/\2-12-\1 \3 | INFO     | redis                | \4/

# Handle WARNING level (# prefix)
s/^[0-9]*:[MSCX] \([0-9]*\) Jan \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-01-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Feb \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-02-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Mar \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-03-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Apr \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-04-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) May \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-05-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Jun \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-06-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Jul \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-07-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Aug \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-08-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Sep \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-09-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Oct \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-10-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Nov \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-11-\1 \3 | WARNING  | redis                | \4/
s/^[0-9]*:[MSCX] \([0-9]*\) Dec \([0-9]*\) \([0-9:]*\)\.[0-9]* # \(.*\)/\2-12-\1 \3 | WARNING  | redis                | \4/

# Handle DEBUG level (. prefix)
s/^[0-9]*:[MSCX] \([0-9]*\) \(...\) \([0-9]*\) \([0-9:]*\)\.[0-9]* \. \(.*\)/DEBUG level not shown/
'
